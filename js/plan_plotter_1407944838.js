 
/*
  Updated: 2014-08-13 11:47:22.220135
  Readable Source in //Ceres/training/webmaps/Bsouthga_mugroup/webdev_repo/stateOfRetirement/js/
  bsouthga(at)urban(dot)org
*/

"use strict";var planid=get_link_params().planid;var json_file='./plan_data/json/'+planid+'_details.json';$.ajax({url:json_file,type:'GET',error:function(){window.location='./index.html';},success:function(){$.getJSON(json_file,function(data){$(document).ready(function(){draw_interface(data);});});}});function get_link_params(){var match;var pl=/\+/g;var search=/([^&=]+)=?([^&]*)/g;var decode=function(s){return decodeURIComponent(s.replace(pl," "));};var query=window.location.search.substring(1);var urlParams={};while(match=search.exec(query))urlParams[decode(match[1])]=decode(match[2]);return urlParams;};var in_array=function(e,l){return $.inArray(e,l)!==-1;};function series_equal(seriesA,seriesB){for(var p=0,l=seriesA.length;p<l;p++)if(seriesA[p].y!=seriesB[p].y)return false;return true;}function series_parser(series,last_point_null){if(last_point_null){var last_point=series[series.length-1];last_point.y=null;series[series.length-1]=last_point;}return series;}function draw_interface(data){var back_to_map_button='<a align="right" class="dlButton" href="./index.html?planid='+planid+'">Return To Map (This Plan)</a>';var back_to_top_map='<a align="right" class="dlButton" href="./index.html">Return To Map (Top)</a>';var top_title_text=titleCaps(data.state+' '+data.occupation+(data.tier?', '+data.tier:' '));$("head").append('<title>'+top_title_text+'</title>');$('#top_header').html(top_title_text+' - <i>Plan Details</i>');var lower_tier='';if(data.tier!=null)lower_tier=data.tier.slice(0,1).toLowerCase()+data.tier.slice(1,data.tier.length);$("#header_table").append('<tr><td class="header_titles"><b>State: </b></td><td>'+data.state+'</td></tr>'+'<tr><td class="header_titles"><b>Covered Employees:</b> </td><td>'+data.occupation+' '+lower_tier+'</td></tr>'+'<tr><td class="header_titles"><b>Plan Name:</b> </td><td>'+data.name+'</td></tr>');$('#plot_header').append('<td class="stateOcc" colspan="2"> Plan Outcomes as Multiple of Final Salary, by Quit Age (Employees Hired at Age 25)</td>');$('#bottom_buttons').html(back_to_map_button+back_to_top_map);$('#citation').html('Source: Calculations from the Urban Institute\'s State and Local Employee Pension Plan database (SLEPP).</br>Plan ID: '+planid);generate_table(data);$('.spec_age_row').hover(function(e){var c_lst=$(e.currentTarget).prop('class').split(" ");var c_num=c_lst[c_lst.length-1];$('.series_table_value').not('.series_table_value.'+c_num).addClass("fade");$('.spec_category_val').removeClass('fade');},function(e){$('.fade').removeClass("fade");});$('.spec_category_val').hover(function(e){$('.detail_table_row').not($(e.currentTarget).parent()).addClass('fade');var c_lst=$(e.currentTarget).prop('class').split(" ");var c_var=c_lst[c_lst.length-1];$('.spec_category_header:not(.'+c_var+')').addClass('fade');},function(e){$('.fade').removeClass("fade");});$('.series_table_value:not(.spec_age_row)').hover(function(e){var c_lst=$(e.currentTarget).prop('class').split(" ");var c_num=c_lst[c_lst.length-1];var c_par_lst=$($(e.currentTarget.parentNode).children('.spec_category_val')).prop('class').split(" ");var c_var=c_par_lst[c_par_lst.length-1];$('.series_table_value').not('.series_table_value.'+c_num).addClass("fade");$(e.currentTarget.parentNode).children('.series_table_value').removeClass("fade");$('.spec_age_row.'+c_num).removeClass('fade');$('.spec_category_header:not(.'+c_var+')').addClass('fade');$('.detail_table_row').not(e.currentTarget.parentNode).children('.spec_category_val').addClass('fade');},function(e){$('.fade').removeClass("fade");});var benefit_graph_title='Lifetime Pension Benefits (No Contributions)';var main_plot_series=[{type:'line',data:series_parser(data.fig2_gross),name:'Pension Wealth',lineWidth:3,color:'#6699CC'}];var no_net_plot=series_equal(data.fig2_net,data.fig2_gross);if(!no_net_plot){var benefit_graph_title=('Lifetime Pension Benefits <br/> (<span style="font-weight:bold;color:#6699CC">Total</span>'+' and <span style="font-weight:bold;color:#A02022">Net of Employee Contributions</span>)');main_plot_series.push({type:'line',data:series_parser(data.fig2_net),name:'Pension Wealth (Net of Contributions)',lineWidth:3,color:'#A02022'});}results_plot({div_id:'plot',series_array:main_plot_series,title_text:benefit_graph_title,shared:false,min:0});results_plot({div_id:'annben',series_array:[{type:'column',data:series_parser(data.fig1_data),name:'',color:'#6699CC'}],title_text:'Annual Pension Benefits Received at Age 70'});results_plot({div_id:'accrual',series_array:[{type:'line',data:series_parser(data.fig3_data,true),name:'',lineWidth:3,color:(no_net_plot?'#6699CC':'#A02022')}],title_text:'Addition to Lifetime Pension Benefits'+(!no_net_plot?', Net of Employee Contributions':"")+', from Working Another Year',line_0:true});if(data.fig4_data[data.fig4_data.length-1].x==70)data.fig4_data.pop();results_plot({div_id:'extra5',series_array:[{type:'column',data:series_parser(data.fig4_data),name:'',color:(no_net_plot?'#6699CC':'#A02022')}],title_text:'Average Annual Addition to Lifetime Pension Benefits'+(!no_net_plot?', Net of Employee Contributions':"")+', from Working Five More Years',line_0:true});};function results_plot(json){var min_val=0;var index=(json.series_array.length==2?1:0);for(var i=0,l=json.series_array[index].data.length;i<l;i++){var curr_val=json.series_array[index].data[i].y;if(curr_val<min_val)min_val=curr_val;}$('#'+json.div_id).highcharts({title:{text:json.title_text,style:{fontSize:12,color:'#000'}},credits:{enabled:false},legend:json.legend_opts||{enabled:false},navigation:{buttonOptions:{enabled:false}},xAxis:{title:{text:'',style:{color:'#555555'}},lineColor:'#555555',lineWidth:1,tickInterval:5},yAxis:{title:{text:'',style:{color:'#555555'}},lineWidth:1,lineColor:'#555555',min:min_val,tickPixelInterval:30,plotLines:(min_val<0?[{value:0,color:'#555555',width:2,zIndex:(json.series_array[0].type==="line"?1:4)}]:null)},plotOptions:{series:{animation:true,marker:{enabled:false}}},tooltip:{formatter:formatter_func,hideDelay:200,shared:json.shared===undefined?true:json.shared},series:json.series_array});};function formatter_func(){return 'Quit at age '+this.x+', <br/>'+Math.round(this.y*1000)/1000+' times final salary';};function commas(number){var negative=(number<0);number=Math.abs(number);var rounded=Math.round(number),n_str=(''+rounded),ln=n_str.length,output='';if(n_str.indexOf("e")!=-1)return n_str;for(var i=1;i<=ln;i++)output=(i%3==0&&i!=ln?",":"")+n_str.charAt(ln-i)+output;;return(negative?'-':'')+output;}function hex_shader(color,percent){var n=parseInt((color.slice(1)),16);var p=Math.round(2.55*percent);var R=(n>>16)+p;var G=(n>>8&0x00ff)+p;var B=(n&0x0000ff)+p;R=(R<255?(R<1?0:R):255)*0x10000;G=(G<255?(G<1?0:G):255)*0x100;B=(B<255?(B<1?0:B):255);return "#"+(0x1000000+R+G+B).toString(16).slice(1);}function table_color(val){if(val=="(N/A)")return "#dddddd";val=Number(val);if(val===0)return "#FFFFFF";var scale=50;var color=(val<0?"#CD5C5C":"#84BE6A");var bounded=Math.max(-scale,Math.min(scale,val));return hex_shader(color,scale-Math.abs(bounded));}function float_fixer(n){var number=new Number(n);return(parseFloat(number.toPrecision(12)));}function get_keys(o,sort_func){var keys=[];for(var k in o)if(o.hasOwnProperty(k))keys.push(k);keys.sort(sort_func);return keys;}function series_to_table(series_object,sort_func,extra_class,percentage){var out_string='',series_keys=get_keys(series_object,sort_func),cell_class="series_table_value "+(extra_class||'')+" ";for(var k=0;k<series_keys.length;k++){var cell_value=series_object[series_keys[k]];cell_value=""+(cell_value!==null?cell_value:'(N/A)');var color=(percentage?table_color(cell_value):"#fff");cell_value+=(cell_value!="(N/A)"&&percentage?"%":"");out_string+=('<td class="'+cell_class+' '+(cell_class=="spec_age_row"?(k+1):k)+'" ;">'+'<div style="margin:0;width:100%;height:100%;background-color:'+color+'">'+(cell_value==="-0%"?"0%":cell_value)+'</div>'+'</td>');}return out_string;}function attribute_section(title){return('<tr class="sectionHeader">'+'<td class="stateOcc" colspan="8">'+title+'</td>'+'</tr>');};function generate_table(data){var PT=(in_array(data.plantype,["FAS","Hybrid","CB","DC"])?data.plantype:"OTHER");function series_tr(title,variable,key_sort_func,val_sort_func,percentage){var out_string='';var sub_df=data[variable];var sub_df_keys=get_keys(sub_df,key_sort_func);out_string+=('<tr>'+'<td colspan="2" class="spec_category_col spec_category_header '+variable+'">'+'<div>'+title+'</div>'+'</td>'+'<td colspan="'+(data.ages_of_hire.length-1)+'" class="spec_category_header"> </td>'+'</tr>');for(var i=0;i<sub_df_keys.length;i++){var key=sub_df_keys[i];if(key!="null"){out_string+=('<tr class="detail_table_row">'+'<td class="spec_category_col spec_category_val '+variable+'">'+'<div>'+key+'</div>'+'</td>');out_string+=series_to_table(sub_df[key],val_sort_func,variable,percentage)+'</tr>';}}return out_string;};var render_table_row=function(obj){var out='';var missing_types=["N/A","","NA","."];if((!obj.plan_types||in_array(PT,obj.plan_types))&&(!obj.miss||!in_array(data[obj.miss],missing_types))){var value=data[obj.v];if((typeof value)=="number")value=(obj.func||float_fixer)(value);out+=('<tr class="planDetailRow">'+'<td class="planDetailCategory">'+obj.txt+':'+'</td>'+'<td class="planDetailValue">'+(value?value:'(Data Not Available)')+'</td>'+'</tr>');}return out;};var build_attribute_table=function(title,rows){var out=attribute_section(title);for(var i=0,l=rows.length;i<l;i++)out+=render_table_row(rows[i]);return out;};var mand_ret_checker=function(n){return(n===0?"No":(n===1?"Yes, but not specified":n));};var formatted_percent=function(n){return percent(n)+'%';};var arc_year=function(n){return percent(n)+'%'+" ("+data.year_ended1+")";};var numeric_string_sort=function(a,b){return(+a>+b)-(+a<+b);};var range_string_sort=function(a,b){a=a.split('-')[0],b=b.split('-')[0];return numeric_string_sort(a,b);};var dataOrderRef=["OVRL","YGGD","DYGD","OLGD","S1GD","S3GD","AGGD","FDGD"];var col_text=["Overall Grade","Rewarding Younger Workers","Promoting a  Dynamic Workforce","Encouraging Work at Older Ages","Retirement Income</br>for Short-Term Employees","Retirement Income</br>for Long-Term Employees","Making Required Contributions","Funding Ratio"];var cols=[];for(var i=0,l=dataOrderRef.length;i<l;i++)cols.push({text:col_text[i],code:dataOrderRef[i]});var colWidth="112px";var pt_rename={"FAS":"Final average salary defined benefit.","DC":"Defined Contribution","CB":"Cash Balance","Hybrid":"Hybrid (Defined benefit and defined contribution)","FL":"Flat-dollar defined benefit","OTHER":"Other"};data.plantype=pt_rename[PT];if(in_array(PT,["DC","CB"]))data.vesting=data.dc_vesting;if(PT!=="DC"){var mean=0;for(var i=1;i<5;i++){var a=data["arc_"+i];if(a!==null)mean+=a;else{mean=false;break;}}data.arc_avg=!(mean===false)?mean/4:null;var funding_rows=[{v:'AVA',txt:'Actuarial value of assets (millions)',func:commas},{v:'actuarial_liability',txt:'Actuarial liability (millions)',func:commas},{v:'funding_ratio',txt:'Funding ratio',func:formatted_percent},{v:'interest_rate',txt:'Assumed interest rate',func:formatted_percent},{v:'arc_1',txt:'Percentage of required contributions made in the last available year',func:arc_year},{v:'arc_avg',txt:'Average percentage of required contributions made over the last 4 available years',func:formatted_percent},{v:'valuation_date',txt:'Date of actuarial valuation'}];$('#funding_table').append(build_attribute_table('Plan Funding Status',funding_rows));}var plan_detail_rows=[{v:'plantype',txt:'Plan type'},{v:'vesting',txt:(PT==="Hybrid"?"Defined benefit v":"V")+'esting period (years)'},{v:'dc_vesting',txt:'Defined contribution vesting period (years)',plan_types:["Hybrid"]},{v:'formula',txt:'Benefit formula',plan_types:["FAS","Hybrid","OTHER"]},{v:'multiplier',txt:'Multiplier',plan_types:["FAS","Hybrid","OTHER"]},{v:'fas',txt:'Final average salary calculation',plan_types:["FAS","Hybrid","OTHER"]},{v:'normal_eligibility',txt:'Normal retirement eligibility (Age/YOS)',plan_types:["FAS","CB","Hybrid","OTHER"]},{v:'early_eligibility',txt:'Early retirement eligibility (Age/YOS)',plan_types:["FAS","CB","Hybrid","OTHER"]},{v:'penalty',txt:'Penalty for early retirement',plan_types:["FAS","CB","Hybrid","OTHER"],miss:"early_eligibility"},{v:'early_formula',txt:'Early retirement formula',plan_types:["FAS","CB","Hybrid","OTHER"],miss:"early_formula"},{v:'MNRT',txt:'Mandatory retirement age',plan_types:["FAS","CB","Hybrid","OTHER"],func:mand_ret_checker},{v:'drop',txt:'Deferred Retirement Option Program (DROP) available?',plan_types:["FAS","CB","Hybrid","OTHER"]},{v:'cola',txt:'Cost-of-living adjustment',plan_types:["FAS","Hybrid","OTHER"]},{v:'contribution_rate',txt:'Employee contribution rate'+(PT=="Hybrid"?" (DB)":""),plan_types:["FAS","Hybrid","OTHER"]},{v:'ss_coverage',txt:'Covered by Social Security'},{v:'employer_contribution',txt:'Employer contribution rate',plan_types:["CB","DC","Hybrid","OTHER"]},{v:'dc_employee_contribution',txt:'Employee contribution rate'+(PT=="Hybrid"?" (DC)":""),plan_types:["CB","DC","Hybrid","OTHER"]},{v:'dc_interest_rate',txt:'Interest earned on accounts',plan_types:["CB","DC","Hybrid","OTHER"]},{v:'notes',txt:'Notes',miss:'notes'}];var membership_rows=[{v:'actives_count',txt:'Active members',func:commas},{v:'total_count',txt:'Total members',func:commas},{v:'count_date',txt:'Date of membership information'}];$('#attributes_table').append(build_attribute_table('Plan Attributes',plan_detail_rows));$('#membership_table').append(build_attribute_table('Plan Membership',membership_rows));$('#specs_table').append(attribute_section('Growth in Expected Lifetime Pension Benefits over a Career, Net of Employee Contributions, by Age of Hire')+'<tr>'+'<td class="spec_category_col"></td>'+'<td id="spec_age_header" colspan="'+data.ages_of_hire.length+'">Age of Hire</td>'+'</tr>'+'<tr>'+'<td class="spec_category_col"></td>'+series_to_table(data.ages_of_hire,numeric_string_sort," spec_age_row")+'</tr>'+series_tr('','maxvals',numeric_string_sort,numeric_string_sort)+series_tr("Percentage of maximum lifetime benefits, net of employee contributions, accumulated by year of service:","value_pcts",numeric_string_sort,numeric_string_sort,true)+series_tr("Annual change in lifetime benefits, net of employee contributions, as a percentage of current salary, by current age:","accruals",numeric_string_sort,numeric_string_sort,true)+series_tr("Average annualized five-year change in lifetime benefits, net of employee contributions, as a percentage of current salary, by current age:","five_year_accruals",range_string_sort,numeric_string_sort,true)+series_tr("Key Ages:","key_ages",numeric_string_sort,numeric_string_sort));$('#grade_table').append(attribute_section('Plan Grades')+'<tr>'+'<td colspan="7">'+'<table>'+'<tr>'+grade_var_header(colWidth,cols)+'</tr>'+'<tr>'+grade_var_images(data,dataOrderRef,colWidth)+'</tr>'+'</table>'+'<table>'+'<tr>'+'<td class="textPart textPartOne" width="300px">'+younger_workers(data)+'<br/><br/>'+dynamic_workforce(data)+'<br/><br/>'+encouraging_work(data,data.occupid)+'</td>'+'<td class="textPart textPartOne" width="300px">'+retirement_security_short(data,data.occupid)+'<br/><br/>'+retirement_security_long(data,data.occupid)+'</td>'+'<td class="textPart textPartTwo" width="300px">'+required_contributions(data)+'<br/><br/>'+plan_funding(data)+'<br/><br/>'+'</td>'+'</tr>'+'</table>'+'</td>'+'</tr>');};var small="(a|after|before|an|and|as|at|but|by|en|for|if|in|of|on|or|the|to|v[.]?|via|vs[.]?)";var punct="([!\"#$%&'()*+,./:;<=>?@[\\\\\\]^_`{|}~-]*)";var titleCaps=function(title){var parts=[],split=/[:.;?!] |(?: |^)["Ò]/g,index=0;while(true){var m=split.exec(title);parts.push(title.substring(index,m?m.index:title.length).replace(/\b([A-Za-z][a-z.'Õ]*)\b/g,function(all){return /[A-Za-z]\.[A-Za-z]/.test(all)?all:upper(all);}).replace(RegExp("\\b"+small+"\\b","ig"),lower).replace(RegExp("^"+punct+small+"\\b","ig"),function(all,punct,word){return punct+upper(word);}).replace(RegExp("\\b"+small+punct+"$","ig"),upper));index=split.lastIndex;if(m)parts.push(m[0]);else break;}return parts.join("").replace(/ V(s?)\. /ig," v$1. ").replace(/(['Õ])S\b/ig,"$1s").replace(/\b(AT&T|Q&A)\b/ig,function(all){return all.toUpperCase();});};function lower(word){return word.toLowerCase();}function upper(word){return word.substr(0,1).toUpperCase()+word.substr(1);}function percent(x,dec){var dec=dec||2;return Math.round(Number(x)*(100*Math.pow(10,dec)))/Math.pow(10,dec);}