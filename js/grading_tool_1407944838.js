 
/*
  Updated: 2014-08-13 11:47:21.840131
  Readable Source in //Ceres/training/webmaps/Bsouthga_mugroup/webdev_repo/stateOfRetirement/js/
  bsouthga(at)urban(dot)org
*/

$(document).ready(function(){$('body').removeClass('hidden_start');ie_check(function(){"use strict";var vlist=["YGGD","DYGD","OLGD","S1GD","S3GD","AGGD","FDGD"];var vtext={"OVRL":"Overall","YGGD":"Rewarding Younger Workers","DYGD":"Promoting a  Dynamic Workforce","OLGD":"Encouraging Work at Older Ages","S1GD":"Providing Retirement Income to Short-Term Employees","S3GD":"Providing Retirement Income to Long-Term Employees","AGGD":"Making Required Contributions","FDGD":"Funding Ratio"};var grade_numbers={A:4,B:3,C:2,D:1,F:0};var grade_letters=["F","D","C","B","A"];var letter_colors={"A":'#6699CC',"B":'#D1DCEE',"C":'#ECD7C2',"D":'#F9A458',"F":'#A02022',"(NA)":'#555555'};var calculated_grades;var grade_criteria_defaults;function assert(condition){if(!condition)throw Error("Assertion Failed.");}function calculate_grades(calculator){var grades={state:{"OVRL":{A:0,B:0,C:0,D:0,F:0,"(NA)":0}},plan:{"OVRL":{A:0,B:0,C:0,D:0,F:0,"(NA)":0}}};for(var i=0;i<vlist.length;i++){grades.state[vlist[i]]={A:0,B:0,C:0,D:0,F:0,"(NA)":0};grades.plan[vlist[i]]={A:0,B:0,C:0,D:0,F:0,"(NA)":0};}var vlist_length=vlist.length;for(var state in data){var state_grade_object={};for(var i=0;i<vlist_length;i++){state_grade_object[vlist[i]]={};state_grade_object[vlist[i]].gpa=0;state_grade_object[vlist[i]].var_weight_from_plans=0;}for(var occ in data[state])for(var planid in data[state][occ]){var curr_plan_weight=(plan_weights.hasOwnProperty(planid)?+plan_weights[planid].weight:0);if(planid!=="XX00"&&curr_plan_weight!==0)for(var hiredate in data[state][occ][planid]){var overall_plan_grade=0;var total_plan_weight=0;var f_count=0;for(var i=0;i<vlist_length;i++){var v=vlist[i];var plan_object=data[state][occ][planid][hiredate];var results_object={"occ":occ,"detail":plan_object[v.slice(0,2)+"DT"],"DROP":plan_object.DROP,"MAXV":plan_object.MAXV,"age_compare":(plan_object.occupid=="PF"?55:65),"variable":v};var plan_grade=calculator[v].func(results_object);grades.plan[v][plan_grade]++;if(plan_grade==="(NA)"||plan_grade==="F")f_count++;if(plan_grade!="(NA)"){overall_plan_grade+=grade_numbers[plan_grade]*calculator[v].weight;total_plan_weight+=calculator[v].weight;state_grade_object[v].gpa+=grade_numbers[plan_grade]*curr_plan_weight;state_grade_object[v].var_weight_from_plans+=curr_plan_weight;}}var rounded=Math.round(overall_plan_grade/total_plan_weight);rounded*=(f_count<4?1:0);grades.plan.OVRL[grade_letters[rounded]]++;}}var state_overall=0;var state_overall_weight=0;for(var state_grade in state_grade_object){var gpa_weighting=state_grade_object[state_grade].var_weight_from_plans;if(gpa_weighting!==0){var grade_decimal=state_grade_object[state_grade].gpa/gpa_weighting;grades.state[state_grade][grade_letters[Math.round(grade_decimal)]]++;state_overall+=grade_decimal*calculator[state_grade].weight;state_overall_weight+=calculator[state_grade].weight;}else grades.state[state_grade]["(NA)"]++;}grades.state.OVRL[grade_letters[Math.round(state_overall/state_overall_weight)]]++;}return grades;}function control_clicks(){$('.control_button').click(function(e){$('.control_button').prop('class','control_button button');$(e.currentTarget).addClass('selected_button');single_chart(e.currentTarget.id);});$('.form_header').click(function(e){var form=$("#"+e.currentTarget.id+".form_container");if(form.css('display')=='none')$(e.currentTarget).text('(Hide Criteria)');else $(e.currentTarget).text('(Change Criteria)');form.toggle();});$('.param_reset_button').click(function(e){set_variable_defaults(e.currentTarget.id);update_calculator();});var display_classes=["dist_select_button","chart_number_select","num_format"];for(var c=0;c<display_classes.length;c++)$('.'+display_classes[c]).click((function(){var disp_cls=display_classes[c];return function(e){$('.'+disp_cls).removeClass('selected_button');$(e.currentTarget).addClass('selected_button');update_calculator();};})());}function parameter_changes(){$('.calculate_button, .control_button').click(function(e){update_calculator();});}function add_button(opts){var button_string=''+'<tr><td><div id="'+opts.id+'" class="control_button button">'+opts.text+'</div></td></tr>';$('#grade_controls').append(button_string);}function add_grade_control(opts){add_button(opts);if(opts.no_params)return null;var input_string='';for(var g in grade_numbers){if(g=="F")input_string+='<li style="height:0;color:#fff;"></li>';input_string+='<li><input type="text" id="'+opts.id+'_input_'+g+'" class="grade_parameter_input"/></li>';}$('#grade_controls').append('<tr><td>'+'<div id="'+opts.id+'" class="form_header">(Change Criteria)</div>'+'<div id="'+opts.id+'" class="form_container">'+'Grade Criteria <span id="'+opts.id+'" class="param_reset_button button" >Defaults</span>'+'<ol id="'+opts.id+'" class="grade_parameter_form"> '+input_string+'<li style="list-style-type:none"><span id="'+opts.id+'" class="calculate_button button">Calculate</span></li>'+'</ol>'+'Weight in "Overall" grade: <input type="text" id="'+opts.id+'_weight_input" class="weight_input"/>'+'</div>'+'</tr></td>');}function add_controls(){add_grade_control({id:"OVRL",text:vtext.OVRL,no_params:true});add_grade_control({id:"YGGD",text:vtext.YGGD});add_grade_control({id:"DYGD",text:vtext.DYGD});add_grade_control({id:"OLGD",text:vtext.OLGD});add_grade_control({id:"S1GD",text:vtext.S1GD});add_grade_control({id:"S3GD",text:vtext.S3GD});add_grade_control({id:"AGGD",text:vtext.AGGD});add_grade_control({id:"FDGD",text:vtext.FDGD});$(".form_container").toggle();$("#OVRL.control_button").addClass('selected_button');$('#current_grade_text').text(vtext.OVRL);for(var v in grade_criteria_defaults)set_variable_defaults(v);}function data_series(grades,percentage){var out=[];var g_tot=0;for(var l in grades)g_tot+=grades[l];for(var letter in grades)out.push({y:(percentage?Math.round(grades[letter]*100/g_tot):grades[letter]),dataLabels:{enabled:true,align:'center',style:{fontWeight:'bold'},verticalAlign:'top',formatter:function(){return this.y+(percentage?"%":"");},y:-18},color:letter_colors[letter]});return out;}function render_chart(v_name,grades,div_id,single_chart){var percentage=$('.num_format.selected_button').prop('id')==="per";var state=$('.dist_select_button.selected_button').prop('id')==="state";var h=(single_chart?400:160);var w=(single_chart?700:160);$(div_id).highcharts({chart:{type:'column',height:h,width:w},title:{text:''},legend:{enabled:false},exporting:{enabled:false},credits:{enabled:false},xAxis:{categories:['A','B','C','D','F','(NA)'],tickWidth:0},yAxis:{min:0,max:(percentage?100:50*(state?1:10)),title:{text:''},lineWidth:0,tickWidth:0,gridLineWidth:0,labels:{enabled:false}},plotOptions:{column:{pointPadding:-0.1,borderWidth:0,dataLabels:{crop:false,overflow:"none"}},series:{states:{hover:{enabled:false}},animation:false}},series:[{name:v_name,data:data_series(grades,percentage)}],tooltip:{formatter:function(){return this.series.name+'<br/>Grade: '+this.x+', '+(state?'States':'Plans')+': '+this.y;},enabled:($('.chart_number_select.selected_button').prop('id')=="single")}});}function get_grades(variable){var dist=$('.dist_select_button.selected_button').prop('id');return calculated_grades[dist][variable];}function single_chart(variable){$('#chart').empty();$('#current_grade_text').text(vtext[variable]);render_chart(vtext[variable],get_grades(variable),'#chart',true);}function all_charts(){var state=$('.dist_select_button.selected_button').prop('id')=="state";$('#current_grade_text').text(((state?"State":"Plan")+" Level Distribution"));$('#chart').remove();$('#main_chart').append('<div id="chart"></div>');$('#chart').append('<table id="chart_table"><tbody><tr id="header0"></tr><tr id="row0"></tr><tbody></table>');var chart_list=["OVRL"].concat(vlist);var row=0;for(var c=0,l=chart_list.length;c<l;c++){var v=chart_list[c];if(c>0&&c%4===0){row++;$('#chart_table').append('<tr id="header'+row+'"></tr><tr id="row'+row+'"></tr>');};$('#chart_table tr#header'+row).append('<td class="header_row">'+vtext[v]+'</td>');$('#chart_table tr#row'+row).append('<td id="'+v+'_container" class="all_chart_container"></td>');render_chart(vtext[v],get_grades(v),'#'+v+'_container',false);}}function interval_func(in_string){var single_number;var interval;var left_inc;var right_inc;var invalid_rg=/[^\-\[\]\(\)\,\.\d+]/gi;var interval_rg=/(\[|\().+\,.+(\)|\])/gi;var start_rg=/(\[|\()\d?.?\d+\,/gi;var end_rg=/\, ?\d?.?\d+(\]|\))/gi;var bounds_rg=/[\[\]\)\(]/gi;var s=in_string.replace(invalid_rg,"");if(interval_rg.test(s)){left_inc=(s.charAt(0)=="[");right_inc=(s.charAt(s.length-1)=="]");interval=$.map(s.replace(bounds_rg,"").split(","),function(a){return Number(a);});}else if(/\d*\.?\d+/.test(s))single_number=+s.match(/-?\d*\.?\d+/)[0];else return null;if(single_number!==undefined)return(function(num){return function(n){assert(typeof n==="number");return(Math.min(n,1)===num);};})(single_number);else return function(n){assert(typeof n==="number");var n=Math.min(n,1);var a=interval[0];var b=interval[1];var lower=(n>a||(left_inc?n===a:false));var upper=(n<b||(right_inc?n===b:false));return(lower&&upper);};}function variable_checker(v){var grade_funcs={};for(var letter in grade_numbers)grade_funcs[letter]=(function(l){var param=document.getElementById(''+v+'_input_'+l).value;return interval_func(param);})(letter);var checker=function(results_object){var detail=Number(results_object.detail);if(results_object.detail===""||isNaN(detail))return "(NA)";for(var letter in grade_funcs)if(grade_funcs[letter](detail))return letter;alert('Grading Criteria for:\n\n\t"'+vtext[results_object.variable]+'"\n\ndoes not cover all values in [0,1], re-check the given intervals / values.\n\nValue '+detail+' was tried and failed to produce a grade.');throw "No grade calculated, detail given = "+detail+", for variable: "+vtext[results_object.variable];};return checker;}function grade_calculator(){var calculator={};for(var i=0;i<vlist.length;i++){var v=vlist[i];calculator[v]={};calculator[v].func=variable_checker(v);var weight=document.getElementById(''+v+'_weight_input').value.replace(/[^\d\.]/,"").match(/\d*\.?\d+/);if(weight!=null)calculator[v].weight=+weight[0];else{alert("Invalid weight specified for variable:\n\n"+vtext[v]+"\n\nMust be a number.");throw "Invalid weight for "+v;}}calculator.OLGD.func=(function(){var old_func=calculator.OLGD.func;return function(results_object){results_object.detail=Math.max(-1,Math.min(0,+results_object.detail));var out;if(results_object.MAXV&&results_object.MAXV>results_object.age_compare)out="A";else if(Number(results_object.DROP)===1&&Number(results_object.detail)!==1)out="B";else out=old_func(results_object);return out;};})();return calculator;}function update_calculator(){calculated_grades=calculate_grades(grade_calculator());var selected_dist=$('.chart_number_select.selected_button').prop('id');if(selected_dist=="single"){var curr_var=$('.control_button.selected_button').prop('id');single_chart(curr_var);}else all_charts();}function set_variable_defaults(v){grade_criteria_defaults=load_defaults();for(var g in grade_criteria_defaults[v])if(g=="weight")$('#'+v+'_weight_input').val(grade_criteria_defaults[v][g]);else $('#'+v+'_input_'+g+".grade_parameter_input").val(grade_criteria_defaults[v][g]);}function load_defaults(){var grade_criteria_defaults={"YGGD":{"A":'[.1, 1]',"B":'[.05, .1)',"C":'[.03, .05)',"D":'(0, .03)',"F":'0'},"DYGD":{"A":'[0, .05]',"B":'(.05, .1]',"C":'(.1, .25]',"D":'(.25, .5]',"F":'(.5, 1]'},"OLGD":{"A":'0',"B":'[-0.1, 0)',"C":'[-0.25, -0.1)',"D":'[-.5, -.25)',"F":'[-1, -.5)'},"S1GD":{"A":'[.8, 1]',"B":'[.7, .8)',"C":'[.6, .7)',"D":'[.5, .6)',"F":'[0, .5)'},"S3GD":{"A":'[.8, 1]',"B":'[.7, .8)',"C":'[.6, .7)',"D":'[.5, .6)',"F":'[0, .5)'},"AGGD":{"A":'1',"B":'[.9, 1)',"C":'[.75, .9)',"D":'[.6, .75)',"F":'[0, .6)'},"FDGD":{"A":'1',"B":'[.9, 1)',"C":'[.75, .9)',"D":'[.6, .75)',"F":'[0, .6)'}};for(var v in grade_criteria_defaults)grade_criteria_defaults[v].weight=1;return grade_criteria_defaults;}grade_criteria_defaults=load_defaults();add_controls();control_clicks();update_calculator();parameter_changes();});});